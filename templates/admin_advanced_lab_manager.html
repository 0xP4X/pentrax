{% extends 'base.html' %}
{% block title %}Advanced Lab Management - Admin{% endblock %}

{% block extra_css %}
<style>
    .lab-card {
        transition: transform 0.2s;
        border-left: 4px solid #007bff;
    }
    .lab-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .lab-card.premium {
        border-left-color: #ffc107;
    }
    .lab-card.ctf {
        border-left-color: #dc3545;
    }
    .lab-card.sandbox {
        border-left-color: #28a745;
    }
    .lab-card.terminal {
        border-left-color: #17a2b8;
    }
    .lab-card.quiz {
        border-left-color: #6f42c1;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .quick-actions {
        position: sticky;
        top: 20px;
    }
    .lab-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .difficulty-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
    .progress-ring {
        width: 60px;
        height: 60px;
    }
    .progress-ring circle {
        fill: none;
        stroke-width: 4;
    }
    .progress-ring .bg {
        stroke: #e9ecef;
    }
    .progress-ring .progress {
        stroke: #007bff;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header with Stats -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-flask"></i> Advanced Lab Management</h2>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-plus"></i> Create New
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#createLabModal">
                            <i class="fas fa-flask"></i> Standard Lab
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#createCTFModal">
                            <i class="fas fa-flag"></i> CTF Challenge
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#createPathModal">
                            <i class="fas fa-route"></i> Learning Path
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#createSandboxModal">
                            <i class="fas fa-cube"></i> Sandbox Environment
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#createQuizModal">
                            <i class="fas fa-question-circle"></i> Quiz Lab
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Labs</h6>
                            <h3>{{ stats.total_labs }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-flask fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Users</h6>
                            <h3>{{ stats.active_users }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">CTF Challenges</h6>
                            <h3>{{ stats.ctf_challenges }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-flag fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Learning Paths</h6>
                            <h3>{{ stats.learning_paths }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-route fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchLabs" placeholder="Search labs...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="filterType">
                                <option value="">All Types</option>
                                <option value="standard">Standard</option>
                                <option value="terminal">Terminal</option>
                                <option value="sandbox">Sandbox</option>
                                <option value="quiz">Quiz</option>
                                <option value="ctf">CTF</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="filterDifficulty">
                                <option value="">All Difficulties</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                                <option value="expert">Expert</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="filterCategory">
                                <option value="">All Categories</option>
                                <option value="web">Web Security</option>
                                <option value="network">Network Security</option>
                                <option value="crypto">Cryptography</option>
                                <option value="forensics">Forensics</option>
                                <option value="reverse">Reverse Engineering</option>
                                <option value="pwn">Pwn</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary" id="clearFilters">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Labs Grid -->
            <div class="row" id="labsGrid">
                {% for lab in labs %}
                <div class="col-md-6 col-lg-4 mb-4 lab-item" 
                     data-type="{{ lab.lab_type }}" 
                     data-difficulty="{{ lab.difficulty }}" 
                     data-category="{{ lab.category }}"
                     data-title="{{ lab.title|lower }}">
                    <div class="card lab-card {{ lab.lab_type }} {% if lab.is_premium %}premium{% endif %}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="lab-type-badge badge bg-primary">{{ lab.lab_type|title }}</span>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{{ url_for('admin_edit_lab', lab_id=lab.id) }}">
                                        <i class="fas fa-edit"></i> Edit
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="duplicateLab({{ lab.id }})">
                                        <i class="fas fa-copy"></i> Duplicate
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="previewLab({{ lab.id }})">
                                        <i class="fas fa-eye"></i> Preview
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteLab({{ lab.id }})">
                                        <i class="fas fa-trash"></i> Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">{{ lab.title }}</h6>
                            <p class="card-text text-muted small">{{ lab.description[:100] }}{% if lab.description|length > 100 %}...{% endif %}</p>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="difficulty-badge badge bg-{{ 'success' if lab.difficulty == 'easy' else 'warning' if lab.difficulty == 'medium' else 'danger' if lab.difficulty == 'hard' else 'dark' }}">
                                    {{ lab.difficulty|title }}
                                </span>
                                <span class="badge bg-info">{{ lab.points }} pts</span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">{{ lab.category|title }}</small>
                                <div>
                                    {% if lab.is_premium %}
                                    <span class="badge bg-warning text-dark">Premium</span>
                                    {% endif %}
                                    {% if lab.is_active %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Completions</small>
                                    <div class="fw-bold">{{ lab.completion_rate|round(1) }}%</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Avg Time</small>
                                    <div class="fw-bold">{{ lab.estimated_time }}m</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Rating</small>
                                    <div class="fw-bold">{{ lab.difficulty_rating|round(1) }}/5</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="quick-actions">
                <!-- Quick Actions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-bolt"></i> Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#bulkActionsModal">
                                <i class="fas fa-tasks"></i> Bulk Actions
                            </button>
                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#importLabsModal">
                                <i class="fas fa-upload"></i> Import Labs
                            </button>
                            <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#exportLabsModal">
                                <i class="fas fa-download"></i> Export Labs
                            </button>
                            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#massUpdateModal">
                                <i class="fas fa-edit"></i> Mass Update
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-clock"></i> Recent Activity</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for activity in recent_activity %}
                            <div class="list-group-item px-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ activity.action }}</h6>
                                    <small class="text-muted">{{ activity.time_ago }}</small>
                                </div>
                                <p class="mb-1">{{ activity.description }}</p>
                                <small class="text-muted">by {{ activity.user }}</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Lab Categories -->
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-tags"></i> Categories</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for category in categories %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                {{ category.name }}
                                <span class="badge bg-primary rounded-pill">{{ category.count }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Lab Modal -->
<div class="modal fade" id="createLabModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Lab</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createLabForm" method="post" action="{{ url_for('admin_create_lab') }}">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Lab Title</label>
                                <input type="text" class="form-control" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Lab Type</label>
                                <select class="form-select" name="lab_type" required>
                                    <option value="standard">Standard Lab</option>
                                    <option value="terminal">Terminal Lab</option>
                                    <option value="sandbox">Sandbox Lab</option>
                                    <option value="quiz">Quiz Lab</option>
                                    <option value="ctf">CTF Challenge</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="category" required>
                                    <option value="web">Web Security</option>
                                    <option value="network">Network Security</option>
                                    <option value="crypto">Cryptography</option>
                                    <option value="forensics">Forensics</option>
                                    <option value="reverse">Reverse Engineering</option>
                                    <option value="pwn">Pwn</option>
                                    <option value="misc">Miscellaneous</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Difficulty</label>
                                <select class="form-select" name="difficulty" required>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                    <option value="expert">Expert</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Points</label>
                                <input type="number" class="form-control" name="points" value="10" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Estimated Time (min)</label>
                                <input type="number" class="form-control" name="estimated_time" value="30" min="1">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Flag</label>
                                <input type="text" class="form-control" name="flag" placeholder="CTF{flag_here}">
                            </div>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="is_premium" id="isPremium">
                        <label class="form-check-label" for="isPremium">Premium Lab</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="createLabForm" class="btn btn-primary">Create Lab</button>
            </div>
        </div>
    </div>
</div>

<!-- Other modals for CTF, Learning Path, Sandbox, Quiz creation will be added here -->
{% endblock %}

{% block extra_js %}
<script>
// Search and filter functionality
document.getElementById('searchLabs').addEventListener('input', filterLabs);
document.getElementById('filterType').addEventListener('change', filterLabs);
document.getElementById('filterDifficulty').addEventListener('change', filterLabs);
document.getElementById('filterCategory').addEventListener('change', filterLabs);
document.getElementById('clearFilters').addEventListener('click', clearFilters);

function filterLabs() {
    const searchTerm = document.getElementById('searchLabs').value.toLowerCase();
    const typeFilter = document.getElementById('filterType').value;
    const difficultyFilter = document.getElementById('filterDifficulty').value;
    const categoryFilter = document.getElementById('filterCategory').value;
    
    const labItems = document.querySelectorAll('.lab-item');
    
    labItems.forEach(item => {
        const title = item.dataset.title;
        const type = item.dataset.type;
        const difficulty = item.dataset.difficulty;
        const category = item.dataset.category;
        
        const matchesSearch = title.includes(searchTerm);
        const matchesType = !typeFilter || type === typeFilter;
        const matchesDifficulty = !difficultyFilter || difficulty === difficultyFilter;
        const matchesCategory = !categoryFilter || category === categoryFilter;
        
        if (matchesSearch && matchesType && matchesDifficulty && matchesCategory) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function clearFilters() {
    document.getElementById('searchLabs').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterDifficulty').value = '';
    document.getElementById('filterCategory').value = '';
    filterLabs();
}

function duplicateLab(labId) {
    if (confirm('Duplicate this lab?')) {
        window.location.href = `/admin/labs/${labId}/duplicate`;
    }
}

function previewLab(labId) {
    window.open(`/labs/${labId}`, '_blank');
}

function deleteLab(labId) {
    if (confirm('Are you sure you want to delete this lab? This action cannot be undone.')) {
        fetch(`/admin/labs/${labId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error deleting lab');
            }
        });
    }
}
</script>
{% endblock %} 