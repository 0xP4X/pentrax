{% extends "base.html" %}

{% block title %}{{ user.username }} - PentraX{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  {% if current_user.is_admin %}
    <!-- Advanced Admin User Profile: Tabbed Interface -->
    <div class="card mb-4">
      <div class="card-header bg-dark text-white d-flex align-items-center justify-content-between">
        <h5 class="mb-0"><i class="fas fa-user-shield"></i> Admin User Overview</h5>
        <span>
          {% if user.is_admin %}<span class="badge bg-danger" title="Admin"><i class="fas fa-crown"></i> Admin</span>{% endif %}
          {% if user.is_premium %}<span class="badge bg-warning text-dark" title="Premium"><i class="fas fa-gem"></i> Premium</span>{% endif %}
          {% if user.is_banned %}<span class="badge bg-danger" title="Banned"><i class="fas fa-ban"></i> Banned</span>{% endif %}
          {% if user.is_muted %}<span class="badge bg-info text-dark" title="Muted"><i class="fas fa-volume-mute"></i> Muted</span>{% endif %}
        </span>
      </div>
      <div class="card-body">
        <!-- Quick Stats Cards -->
        <div class="row mb-4 text-center">
          <div class="col-md-2 col-6 mb-2">
            <div class="card bg-primary text-white">
              <div class="card-body p-2">
                <div class="fs-4"><i class="fas fa-file-alt"></i></div>
                <div class="fw-bold">{{ user_posts|length }}</div>
                <div class="small">Posts</div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6 mb-2">
            <div class="card bg-success text-white">
              <div class="card-body p-2">
                <div class="fs-4"><i class="fas fa-flask"></i></div>
                <div class="fw-bold">{{ user.lab_completions|length }}</div>
                <div class="small">Labs</div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6 mb-2">
            <div class="card bg-warning text-dark">
              <div class="card-body p-2">
                <div class="fs-4"><i class="fas fa-shopping-cart"></i></div>
                <div class="fw-bold">{{ user.purchases|length }}</div>
                <div class="small">Purchases</div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6 mb-2">
            <div class="card bg-info text-white">
              <div class="card-body p-2">
                <div class="fs-4"><i class="fas fa-star"></i></div>
                <div class="fw-bold">{{ user.reputation }}</div>
                <div class="small">Reputation</div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6 mb-2">
            <div class="card bg-secondary text-white">
              <div class="card-body p-2">
                <div class="fs-4"><i class="fas fa-calendar"></i></div>
                <div class="fw-bold">{{ user.created_at.strftime('%Y-%m-%d') }}</div>
                <div class="small">Joined</div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6 mb-2">
            <div class="card bg-dark text-white">
              <div class="card-body p-2">
                <div class="fs-4"><i class="fas fa-user"></i></div>
                <div class="fw-bold">{{ user.username }}</div>
                <div class="small">Username</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Tabbed Interface -->
        <ul class="nav nav-tabs mb-3" id="adminUserTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">Activity</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">Security</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button" role="tab">Admin Actions</button>
          </li>
        </ul>
        <div class="tab-content" id="adminUserTabContent">
          <!-- Overview Tab -->
          <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <ul class="list-group list-group-flush mb-3">
              <li class="list-group-item"><strong>Email:</strong> {{ user.email }}</li>
              <li class="list-group-item"><strong>Last Login:</strong> {{ user.last_login or 'Never' }}</li>
              <li class="list-group-item"><strong>Last IP:</strong> {{ user.last_ip or 'N/A' }}</li>
              <li class="list-group-item"><strong>Bio:</strong> {{ user.bio or 'No bio provided.' }}</li>
            </ul>
          </div>
          <!-- Activity Tab -->
          <div class="tab-pane fade" id="activity" role="tabpanel">
            <h6>Recent Posts</h6>
            <ul class="list-group mb-3">
              {% for post in user_posts[:5] %}
                <li class="list-group-item">
                  <a href="{{ url_for('post_detail', post_id=post.id) }}">{{ post.title }}</a>
                  <span class="text-muted small">({{ post.created_at.strftime('%Y-%m-%d') }})</span>
                </li>
              {% else %}
                <li class="list-group-item text-muted">No recent posts.</li>
              {% endfor %}
            </ul>
            <h6>Recent Labs Completed</h6>
            <ul class="list-group">
              {% for lab in user.lab_completions[:5] %}
                <li class="list-group-item">
                  <span>{{ lab.lab_title }}</span>
                  <span class="text-muted small">({{ lab.completed_at.strftime('%Y-%m-%d') }})</span>
                </li>
              {% else %}
                <li class="list-group-item text-muted">No recent labs.</li>
              {% endfor %}
            </ul>
          </div>
          <!-- Security Tab -->
          <div class="tab-pane fade" id="security" role="tabpanel">
            <ul class="list-group mb-3">
              <li class="list-group-item"><strong>Account Status:</strong> {% if user.is_banned %}<span class="badge bg-danger">Banned</span>{% else %}<span class="badge bg-success">Active</span>{% endif %}</li>
              <li class="list-group-item"><strong>Muted:</strong> {% if user.is_muted %}<span class="badge bg-info">Yes</span>{% else %}No{% endif %}</li>
              <li class="list-group-item"><strong>Registered:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</li>
              <li class="list-group-item"><strong>Last Login:</strong> {{ user.last_login or 'Never' }}</li>
              <li class="list-group-item"><strong>Last IP:</strong> {{ user.last_ip or 'N/A' }}</li>
            </ul>
            <div class="alert alert-warning small">Security actions (ban, mute, etc.) are not implemented yet.</div>
          </div>
          <!-- Admin Actions Tab -->
          <div class="tab-pane fade" id="actions" role="tabpanel">
            <div class="d-flex gap-2 mb-3 flex-wrap">
              <form method="post" action="{{ url_for('admin_ban_user', user_id=user.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-danger btn-sm" {% if user.is_banned %}disabled{% endif %} onclick="return confirm('Ban this user?');">Ban User</button>
              </form>
              <form method="post" action="{{ url_for('admin_unban_user', user_id=user.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-success btn-sm" {% if not user.is_banned %}disabled{% endif %} onclick="return confirm('Unban this user?');">Unban User</button>
              </form>
              <form method="post" action="{{ url_for('admin_mute_user', user_id=user.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-warning btn-sm" {% if user.is_muted %}disabled{% endif %} onclick="return confirm('Mute this user?');">Mute User</button>
              </form>
              <form method="post" action="{{ url_for('admin_unmute_user', user_id=user.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-info btn-sm" {% if not user.is_muted %}disabled{% endif %} onclick="return confirm('Unmute this user?');">Unmute User</button>
              </form>
              <form method="post" action="{{ url_for('admin_delete_user', user_id=user.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-secondary btn-sm" onclick="return confirm('Delete this user? This cannot be undone.');">Delete User</button>
              </form>
              <form method="post" action="{{ url_for('admin_reset_password', user_id=user.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-info btn-sm">Reset Password</button>
              </form>
              <form method="post" action="{{ url_for('admin_impersonate_user', user_id=user.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-dark btn-sm">Impersonate</button>
              </form>
            </div>
            <div class="alert alert-info small">All admin actions are now live. Use with caution.</div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Activate Bootstrap tabs if needed
      var triggerTabList = [].slice.call(document.querySelectorAll('#adminUserTab button'));
      triggerTabList.forEach(function (triggerEl) {
        var tabTrigger = new bootstrap.Tab(triggerEl);
        triggerEl.addEventListener('click', function (event) {
          event.preventDefault();
          tabTrigger.show();
        });
      });
    </script>
  {% else %}
    <!-- Normal User Profile View -->
    <div class="row">
      <div class="col-md-4 text-center">
        <img src="{{ user.avatar_url or url_for('static', filename='img/default_avatar.png') }}" class="rounded-circle mb-3" width="120" height="120" alt="User Avatar">
        <h3>{{ user.username }}</h3>
        {% if current_user.is_authenticated and current_user.id != user.id %}
        <div class="d-grid gap-2">
          <a href="{{ url_for('follow_user', username=user.username) }}" class="btn btn-primary btn-sm">
            <i class="fas fa-user-plus"></i> Follow
          </a>
        </div>
        {% endif %}
      </div>
      <div class="col-md-8">
        <h4>About</h4>
        <p>{{ user.bio or 'No bio provided.' }}</p>
        <h5>Achievements</h5>
        <ul>
          {% for achievement in achievements %}
            <li>{{ achievement }}</li>
          {% else %}
            <li>No achievements yet.</li>
          {% endfor %}
        </ul>
        <h5>Recent Activity</h5>
        <ul>
          <li><strong>Posts:</strong> {{ user_posts|length }}</li>
          <li><strong>Labs Completed:</strong> {{ user.lab_completions|length }}</li>
          <li><strong>Purchases:</strong> {{ user.purchases|length }}</li>
        </ul>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
