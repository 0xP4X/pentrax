{% extends "base.html" %}

{% block title %}Sandbox Environments - PentraX{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-cube"></i> Sandbox Environments</h1>
                    <p class="text-muted">Isolated environments for safe cybersecurity practice</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('advanced_labs') }}" class="btn btn-outline-primary">
                        <i class="fas fa-graduation-cap"></i> Advanced Labs
                    </a>
                    <a href="{{ url_for('ctf_dashboard') }}" class="btn btn-outline-warning">
                        <i class="fas fa-flag"></i> CTF Challenges
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Sessions -->
    {% if active_sessions %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-play"></i> Active Sessions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for session in active_sessions %}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6>{{ session.sandbox.name }}</h6>
                                            <p class="small text-muted mb-2">{{ session.sandbox.description }}</p>
                                            <div class="d-flex gap-2">
                                                <span class="badge bg-success">{{ session.status|title }}</span>
                                                <span class="badge bg-info">{{ session.sandbox.environment_type|title }}</span>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted d-block">
                                                Started: {{ session.started_at.strftime('%H:%M') }}
                                            </small>
                                            <button class="btn btn-sm btn-danger mt-2" 
                                                    onclick="stopSandbox('{{ session.session_id }}')">
                                                <i class="fas fa-stop"></i> Stop
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {% if session.access_url %}
                                    <div class="mt-3">
                                        <a href="{{ session.access_url }}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="fas fa-external-link-alt"></i> Access Environment
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Available Sandboxes -->
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-list"></i> Available Environments</h2>
            <p class="text-muted">Choose an environment to start practicing</p>
            
            <div class="row">
                {% for sandbox in sandboxes %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">{{ sandbox.name }}</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ sandbox.description }}</p>
                            
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="border rounded p-2">
                                        <i class="fas fa-server text-info"></i>
                                        <div class="small">{{ sandbox.environment_type|title }}</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded p-2">
                                        <i class="fas fa-users text-success"></i>
                                        <div class="small">{{ sandbox.max_concurrent_users }} max</div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if sandbox.resources %}
                            <div class="mb-3">
                                <h6>Resources:</h6>
                                {% set resources = sandbox.resources|from_json %}
                                <ul class="list-unstyled small">
                                    {% if resources.cpu %}
                                    <li><i class="fas fa-microchip"></i> {{ resources.cpu }}</li>
                                    {% endif %}
                                    {% if resources.memory %}
                                    <li><i class="fas fa-memory"></i> {{ resources.memory }}</li>
                                    {% endif %}
                                    {% if resources.storage %}
                                    <li><i class="fas fa-hdd"></i> {{ resources.storage }}</li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="startSandbox({{ sandbox.id }})">
                                    <i class="fas fa-play"></i> Start Environment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-cube fa-3x mb-3"></i>
                        <h5>No sandbox environments available</h5>
                        <p>Check back soon for new environments!</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h6 id="loadingMessage">Starting environment...</h6>
                <p class="small text-muted">This may take a few moments</p>
            </div>
        </div>
    </div>
</div>

<script>
function startSandbox(sandboxId) {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    fetch(`/sandbox/start/${sandboxId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>Success!</strong> Environment started successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
            
            // Reload page after a short delay to show active session
            setTimeout(() => location.reload(), 2000);
        } else {
            // Show error message
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Error!</strong> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
        }
    })
    .catch(error => {
        loadingModal.hide();
        
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>Error!</strong> Failed to start environment.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
    });
}

function stopSandbox(sessionId) {
    if (!confirm('Are you sure you want to stop this environment? All unsaved work will be lost.')) {
        return;
    }
    
    fetch(`/sandbox/stop/${sessionId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>Success!</strong> Environment stopped successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
            
            // Reload page after a short delay
            setTimeout(() => location.reload(), 2000);
        } else {
            // Show error message
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Error!</strong> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
        }
    })
    .catch(error => {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>Error!</strong> Failed to stop environment.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
    });
}

// Auto-refresh active sessions every 30 seconds
setInterval(function() {
    const activeSessions = document.querySelectorAll('[data-session-id]');
    if (activeSessions.length > 0) {
        // This would normally make an AJAX call to check session status
        // For now, we'll just add a subtle animation
        activeSessions.forEach(session => {
            session.style.animation = 'pulse 1s';
            setTimeout(() => {
                session.style.animation = '';
            }, 1000);
        });
    }
}, 30000);
</script>

<style>
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.card {
    transition: all 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %} 