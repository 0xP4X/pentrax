{% extends 'base.html' %}
{% block title %}Lab Analytics - {{ lab.title }}{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        border-left: 4px solid #007bff;
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .metric-card.success {
        border-left-color: #28a745;
    }
    .metric-card.warning {
        border-left-color: #ffc107;
    }
    .metric-card.danger {
        border-left-color: #dc3545;
    }
    .metric-card.info {
        border-left-color: #17a2b8;
    }
    .progress-ring {
        width: 120px;
        height: 120px;
    }
    .progress-ring circle {
        fill: none;
        stroke-width: 8;
    }
    .progress-ring .bg {
        stroke: #e9ecef;
    }
    .progress-ring .progress {
        stroke: #007bff;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dasharray 0.5s ease;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .user-activity {
        max-height: 400px;
        overflow-y: auto;
    }
    .difficulty-distribution {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .difficulty-bar {
        flex: 1;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }
    .difficulty-fill {
        height: 100%;
        transition: width 0.5s ease;
    }
    .difficulty-fill.easy { background: #28a745; }
    .difficulty-fill.medium { background: #ffc107; }
    .difficulty-fill.hard { background: #fd7e14; }
    .difficulty-fill.expert { background: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-chart-line"></i> Lab Analytics</h2>
                    <h4 class="text-muted">{{ lab.title }}</h4>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('admin_edit_lab', lab_id=lab.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Edit Lab
                    </a>
                    <a href="{{ url_for('admin_advanced_labs') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Labs
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <div class="progress-ring mx-auto mb-3">
                        <svg width="120" height="120">
                            <circle class="bg" cx="60" cy="60" r="50"></circle>
                            <circle class="progress" cx="60" cy="60" r="50" 
                                    stroke-dasharray="{{ (analytics.completion_rate * 314 / 100)|round(0) }} 314"></circle>
                        </svg>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <h4 class="mb-0">{{ "%.1f"|format(analytics.completion_rate) }}%</h4>
                        </div>
                    </div>
                    <h6>Completion Rate</h6>
                    <small class="text-muted">{{ analytics.completions }} of {{ analytics.total_attempts }} users</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card success">
                <div class="card-body text-center">
                    <h2 class="text-success">{{ analytics.avg_time|round(0) }}</h2>
                    <h6>Avg. Completion Time</h6>
                    <small class="text-muted">minutes</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card warning">
                <div class="card-body text-center">
                    <h2 class="text-warning">{{ "%.1f"|format(analytics.avg_rating) }}</h2>
                    <h6>Difficulty Rating</h6>
                    <small class="text-muted">out of 5</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card info">
                <div class="card-body text-center">
                    <h2 class="text-info">{{ lab.points }}</h2>
                    <h6>Points Available</h6>
                    <small class="text-muted">per completion</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Charts and Analytics -->
        <div class="col-lg-8">
            <!-- Completion Trends -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-area"></i> Completion Trends</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="completionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- User Performance -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-users"></i> User Performance</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Time Spent</th>
                                    <th>Hints Used</th>
                                    <th>Attempts</th>
                                    <th>Rating</th>
                                    <th>Completed</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for progress in lab.user_progress %}
                                <tr>
                                    <td>
                                        <strong>{{ progress.user.username }}</strong>
                                        {% if progress.user.is_premium %}
                                        <span class="badge bg-warning text-dark ms-1">Premium</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if progress.completed_at %}
                                        <span class="badge bg-success">Completed</span>
                                        {% elif progress.progress_percentage > 0 %}
                                        <span class="badge bg-warning">In Progress</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Not Started</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ (progress.time_spent / 60)|round(1) }} min</td>
                                    <td>{{ progress.hints_used }}</td>
                                    <td>{{ progress.attempts }}</td>
                                    <td>
                                        {% set rating = lab.lab_ratings|selectattr("user_id", "equalto", progress.user_id)|first %}
                                        {% if rating %}
                                        {{ rating.difficulty_rating }}/5
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if progress.completed_at %}
                                        {{ progress.completed_at.strftime('%Y-%m-%d') }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Analytics -->
        <div class="col-lg-4">
            <!-- Lab Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-info-circle"></i> Lab Details</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Category:</strong> {{ lab.category|title }}<br>
                        <strong>Difficulty:</strong> 
                        <span class="badge bg-{{ 'success' if lab.difficulty == 'easy' else 'warning' if lab.difficulty == 'medium' else 'danger' if lab.difficulty == 'hard' else 'dark' }}">
                            {{ lab.difficulty|title }}
                        </span><br>
                        <strong>Type:</strong> {{ lab.lab_type|title }}<br>
                        <strong>Created:</strong> {{ lab.created_at.strftime('%Y-%m-%d') }}<br>
                        <strong>Status:</strong> 
                        <span class="badge bg-{{ 'success' if lab.is_active else 'secondary' }}">
                            {{ 'Active' if lab.is_active else 'Inactive' }}
                        </span>
                    </div>
                    {% if lab.is_premium %}
                    <div class="alert alert-warning">
                        <i class="fas fa-crown"></i> Premium Lab
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Difficulty Distribution -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-chart-pie"></i> Difficulty Ratings</h6>
                </div>
                <div class="card-body">
                    {% set ratings = lab.lab_ratings %}
                    {% set total_ratings = ratings|length %}
                    {% if total_ratings > 0 %}
                        {% set easy_count = ratings|selectattr("difficulty_rating", "equalto", 1)|list|length %}
                        {% set medium_count = ratings|selectattr("difficulty_rating", "equalto", 2)|list|length %}
                        {% set hard_count = ratings|selectattr("difficulty_rating", "equalto", 3)|list|length %}
                        {% set expert_count = ratings|selectattr("difficulty_rating", "equalto", 4)|list|length %}
                        {% set very_hard_count = ratings|selectattr("difficulty_rating", "equalto", 5)|list|length %}
                        
                        <div class="difficulty-distribution mb-2">
                            <span class="small">Easy (1):</span>
                            <div class="difficulty-bar">
                                <div class="difficulty-fill easy" style="width: {{ (easy_count / total_ratings * 100)|round(1) }}%"></div>
                            </div>
                            <span class="small">{{ easy_count }}</span>
                        </div>
                        <div class="difficulty-distribution mb-2">
                            <span class="small">Medium (2):</span>
                            <div class="difficulty-bar">
                                <div class="difficulty-fill medium" style="width: {{ (medium_count / total_ratings * 100)|round(1) }}%"></div>
                            </div>
                            <span class="small">{{ medium_count }}</span>
                        </div>
                        <div class="difficulty-distribution mb-2">
                            <span class="small">Hard (3):</span>
                            <div class="difficulty-bar">
                                <div class="difficulty-fill hard" style="width: {{ (hard_count / total_ratings * 100)|round(1) }}%"></div>
                            </div>
                            <span class="small">{{ hard_count }}</span>
                        </div>
                        <div class="difficulty-distribution mb-2">
                            <span class="small">Expert (4):</span>
                            <div class="difficulty-bar">
                                <div class="difficulty-fill expert" style="width: {{ (expert_count / total_ratings * 100)|round(1) }}%"></div>
                            </div>
                            <span class="small">{{ expert_count }}</span>
                        </div>
                        <div class="difficulty-distribution">
                            <span class="small">Very Hard (5):</span>
                            <div class="difficulty-bar">
                                <div class="difficulty-fill expert" style="width: {{ (very_hard_count / total_ratings * 100)|round(1) }}%"></div>
                            </div>
                            <span class="small">{{ very_hard_count }}</span>
                        </div>
                    {% else %}
                        <p class="text-muted">No ratings yet</p>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-clock"></i> Recent Completions</h6>
                </div>
                <div class="card-body user-activity">
                    {% if analytics.recent_completions %}
                        {% for completion in analytics.recent_completions %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>{{ completion.user.username }}</strong><br>
                                <small class="text-muted">{{ completion.completed_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                            <span class="badge bg-success">Completed</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No recent completions</p>
                    {% endif %}
                </div>
            </div>

            <!-- Lab Features -->
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-cogs"></i> Lab Features</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        {% if lab.terminal_enabled %}
                        <span class="badge bg-info me-1">Terminal Commands</span>
                        {% endif %}
                        {% if lab.quiz_questions %}
                        <span class="badge bg-warning me-1">Quiz Questions</span>
                        {% endif %}
                        {% if lab.lab_hints %}
                        <span class="badge bg-success me-1">Progressive Hints</span>
                        {% endif %}
                        {% if lab.ctf_category %}
                        <span class="badge bg-danger me-1">CTF Challenge</span>
                        {% endif %}
                        {% if lab.sandbox_url %}
                        <span class="badge bg-primary me-1">Sandbox</span>
                        {% endif %}
                    </div>
                    
                    {% if lab.terminal_commands %}
                    <div class="small text-muted">
                        <strong>Terminal Commands:</strong> {{ lab.terminal_commands|length }}
                    </div>
                    {% endif %}
                    
                    {% if lab.quiz_questions %}
                    <div class="small text-muted">
                        <strong>Quiz Questions:</strong> {{ lab.quiz_questions|length }}
                    </div>
                    {% endif %}
                    
                    {% if lab.lab_hints %}
                    <div class="small text-muted">
                        <strong>Hints Available:</strong> {{ lab.lab_hints|length }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Detailed Analytics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Time Distribution</h6>
                            <div class="chart-container">
                                <canvas id="timeChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Attempt Distribution</h6>
                            <div class="chart-container">
                                <canvas id="attemptsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Completion Trends Chart
const completionCtx = document.getElementById('completionChart').getContext('2d');
const completionChart = new Chart(completionCtx, {
    type: 'line',
    data: {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
        datasets: [{
            label: 'Completions',
            data: [12, 19, 15, 25, 22, 30],
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4
        }, {
            label: 'Attempts',
            data: [20, 35, 28, 40, 38, 45],
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Time Distribution Chart
const timeCtx = document.getElementById('timeChart').getContext('2d');
const timeChart = new Chart(timeCtx, {
    type: 'doughnut',
    data: {
        labels: ['0-15 min', '15-30 min', '30-60 min', '60+ min'],
        datasets: [{
            data: [30, 40, 20, 10],
            backgroundColor: [
                '#28a745',
                '#007bff',
                '#ffc107',
                '#dc3545'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Attempts Distribution Chart
const attemptsCtx = document.getElementById('attemptsChart').getContext('2d');
const attemptsChart = new Chart(attemptsCtx, {
    type: 'bar',
    data: {
        labels: ['1', '2', '3', '4', '5+'],
        datasets: [{
            label: 'Users',
            data: [45, 25, 15, 10, 5],
            backgroundColor: '#17a2b8'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Auto-refresh analytics every 5 minutes
setInterval(function() {
    // You can add AJAX call here to refresh data
    console.log('Refreshing analytics...');
}, 300000);
</script>
{% endblock %} 